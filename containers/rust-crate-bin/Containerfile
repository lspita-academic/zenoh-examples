ARG RUST_VERSION=1.92.0
ARG DISTRO_NAME=alpine
ARG DISTRO_VERSION=3.23

ARG RUST_IMAGE=rust:${RUST_VERSION}-${DISTRO_NAME}${DISTRO_VERSION}
ARG RUNTIME_IMAGE=${DISTRO_NAME}:${DISTRO_VERSION}

FROM ${RUST_IMAGE} AS rust
RUN cargo install cargo-chef --locked
WORKDIR /app

# planner and builder in two different stages
# - recipe preparation depends on source code changes
# - recipe cooking depends on recipe changes

FROM rust AS planner
COPY . .
RUN cargo chef prepare --recipe-path recipe.json

FROM rust AS builder
ARG CRATE_PATH
ARG BIN_NAME
COPY --from=planner /app/recipe.json recipe.json
RUN cargo chef cook --recipe-path recipe.json
COPY . .
WORKDIR ${CRATE_PATH}
RUN --mount=type=cache,target=/app/target \
    cargo build --bins && \
    cp /app/target/debug/${BIN_NAME} /tmp/entrypoint

FROM ${RUNTIME_IMAGE} AS runtime
COPY --from=builder /tmp/entrypoint /usr/local/bin/entrypoint
ENTRYPOINT [ "/usr/local/bin/entrypoint" ]
